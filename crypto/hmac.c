#include "hmac.h"
#include "sha.h"
#include "../lib/xmalloc.h"

#include <stdint.h>
#include <string.h>
#include <stdio.h>

#define HMAC_IPAD_64 {              \
    0x36, 0x36, 0x36, 0x36, 0x36,   \
    0x36, 0x36, 0x36, 0x36, 0x36,   \
    0x36, 0x36, 0x36, 0x36, 0x36,   \
    0x36, 0x36, 0x36, 0x36, 0x36,   \
    0x36, 0x36, 0x36, 0x36, 0x36,   \
    0x36, 0x36, 0x36, 0x36, 0x36,   \
    0x36, 0x36, 0x36, 0x36, 0x36,   \
    0x36, 0x36, 0x36, 0x36, 0x36,   \
    0x36, 0x36, 0x36, 0x36, 0x36,   \
    0x36, 0x36, 0x36, 0x36, 0x36,   \
    0x36, 0x36, 0x36, 0x36, 0x36,   \
    0x36, 0x36, 0x36, 0x36, 0x36,   \
    0x36, 0x36, 0x36, 0x36          \
}

#define HMAC_OPAD_64 {              \
    0x5C, 0x5C, 0x5C, 0x5C, 0x5C,   \
    0x5C, 0x5C, 0x5C, 0x5C, 0x5C,   \
    0x5C, 0x5C, 0x5C, 0x5C, 0x5C,   \
    0x5C, 0x5C, 0x5C, 0x5C, 0x5C,   \
    0x5C, 0x5C, 0x5C, 0x5C, 0x5C,   \
    0x5C, 0x5C, 0x5C, 0x5C, 0x5C,   \
    0x5C, 0x5C, 0x5C, 0x5C, 0x5C,   \
    0x5C, 0x5C, 0x5C, 0x5C, 0x5C,   \
    0x5C, 0x5C, 0x5C, 0x5C, 0x5C,   \
    0x5C, 0x5C, 0x5C, 0x5C, 0x5C,   \
    0x5C, 0x5C, 0x5C, 0x5C, 0x5C,   \
    0x5C, 0x5C, 0x5C, 0x5C, 0x5C,   \
    0x5C, 0x5C, 0x5C, 0x5C          \
}

static void byte_xor(unsigned char *, unsigned char *, uint64_t, unsigned char *);

void 
bksmt_sha256_hmac(unsigned char *msg, uint64_t msglen, unsigned char *key, uint64_t klen, unsigned char out[32])
{
    unsigned char k1[64] = HMAC_IPAD_64, k2[64] = HMAC_OPAD_64, sto[32]; 
    byte_xor(k1, key, klen, k1);
    bksmt_sha256_multi(k1, 64, msg, msglen, NULL, 0, sto); 
    byte_xor(k2, key, klen, k2);
    bksmt_sha256_multi(k2, 64, sto, 32, NULL, 0, out); 
}

void 
bksmt_sha224_hmac(unsigned char *msg, uint64_t msglen, unsigned char *key, uint64_t klen, unsigned char out[28])
{
    unsigned char k1[64] = HMAC_IPAD_64, k2[64] = HMAC_OPAD_64, sto[28]; 
    byte_xor(k1, key, klen, k1);
    bksmt_sha224_multi(k1, 64, msg, msglen, NULL, 0, sto); 
    byte_xor(k2, key, klen, k2);
    bksmt_sha224_multi(k2, 64, sto, 28, NULL, 0, out); 
}

static void 
byte_xor(unsigned char *x, unsigned char *y, uint64_t len, unsigned char *out)
{
    uint64_t i;

    for (i = 0; i < len; i++)
        out[i] = x[i] ^ y[i];
}



